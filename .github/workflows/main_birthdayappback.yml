# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy Node.js app to Azure Web App - birthdayAppBack

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js version
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'

      - name: npm install, build, and test
        run: |
          npm install
          npm run build --if-present
          npm run test --if-present

      - name: Zip artifact for deployment
        run: zip release.zip ./* -r

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: release.zip

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    permissions:
      id-token: write #This is required for requesting the JWT

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: node-app

      - name: Unzip artifact for deployment
        run: unzip release.zip
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_7B1997588AF146EF98DE30428766C16D }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_66D46AE4EFB941239E5613EC0CF7B5F8 }}
          sub          name: Azure Static Web Apps CI/CD
          
          on:
            push:
              branches:
                - main
            pull_request:
              types: [opened, synchronize, reopened, closed]
              branches:
                - main
          
          jobs:
            build_and_deploy_job:
              if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
              runs-on: ubuntu-latest
              name: Build and Deploy Job
              steps:
                - name: Checkout code
                  uses: actions/checkout@v3
                  with:
                    submodules: true
                    lfs: false
          
                - name: Set up Node.js version
                  uses: actions/setup-node@v3
                  with:
                    node-version: '18.x'
          
                - name: Install dependencies and build front-end
                  run: |
                    cd FRONT/taskappfront
                    npm install
                    npm run build
          
                - name: Install dependencies and build API
                  run: |
                    cd BACK
                    npm install
                    npm run build
          
                - name: Build And Deploy
                  id: builddeploy
                  uses: Azure/static-web-apps-deploy@v1
                  with:
                    azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
                    repo_token: ${{ secrets.GITHUB_TOKEN }} # Used for Github integrations (i.e. PR comments)
                    action: "upload"
                    ###### Repository/Build Configurations - These values can be configured to match your app requirements. ######
                    # For more information regarding Static Web App workflow configurations, please visit: https://aka.ms/swaworkflowconfig
                    app_location: "FRONT/taskappfront" # App source code path
                    api_location: "BACK" # Api source code path
                    output_location: "build" # Built app content directory - optional
                    ###### End of Repository/Build Configurations ######
          
            close_pull_request_job:
              if: github.event_name == 'pull_request' && github.event.action == 'closed'
              runs-on: ubuntu-latest
              name: Close Pull Request Job
              steps:
                - name: Close Pull Request
                  id: closepullrequest
                  uses: Azure/static-web-apps-deploy@v1
                  with:
                    azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
                    action: "close"scription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_0CE6960686CE4E8F900C694BBC5A2346 }}

      - name: 'Deploy to Azure Web App'
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'birthdayAppBack'
          slot-name: 'Production'
          package: .
          